<!doctype html><html lang="ms"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pegawai • Hantar Minit Curai</title>
<link rel="stylesheet" href="./theme.css">
</head><body>
<div class="banner"></div>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <img src="/logo.png" onerror="this.src='/.netlify/functions/assets/logo.png'">
      <div>
        <h1>PEJABAT PENDIDIKAN DAERAH MERSING</h1>
        <small>APLIKASI PEREKODAN MINIT CURAI • SEKTOR PEMBELAJARAN</small>
      </div>
    </div>
    <div class="spacer"></div>
    <span id="whoami" class="badge hide"></span>
    <a id="btnLogin" class="btn btn-outline">Log Masuk</a>
    <a id="btnLogout" class="btn btn-outline hide">Log Keluar</a>
  </header>
  <main class="kid">

<section class="card card-pad">
  <div class="note">Emel pegawai diambil daripada akaun log masuk.</div>
  <form id="f" class="form kid">
    <div class="row-2">
      <input class="input" name="tarikh" type="date" required>
      <input class="input" name="masa" placeholder="Masa" required>
    </div>
    <div class="row-2">
      <input class="input" name="tempat" placeholder="Tempat" required>
      <input class="input" name="tajuk" placeholder="Tajuk" required>
    </div>
    <textarea class="textarea" name="catatan" rows="4" placeholder="Catatan" required></textarea>
    <textarea class="textarea" name="tindakan_ppd" rows="3" placeholder="Tindakan PPD" required></textarea>
    <textarea class="textarea" name="rumusan" rows="3" placeholder="Rumusan" required></textarea>
    <div class="center">
      <button class="btn btn-primary" type="submit">Hantar kepada Timbalan</button>
      <a id="wa" class="btn btn-gold hide" target="_blank">WhatsApp Timbalan</a>
    </div>
  <div style="display:flex;gap:12px;justify-content:center;margin-top:8px">
  <button class="btn" type="button" onclick="draftPdf()">Jana PDF (DRAF)</button>
  <button class="btn primary" type="button" onclick="hantarTimbalan()">Hantar kepada Timbalan</button>
  <button class="btn" type="button" onclick="toggleStatus(true)">Lihat Status Penghantaran</button>
</div>
</form>
  <p id="ok" class="note hide">✅ Minit dihantar.</p>
</section>
<script>
const me=user(); if(!me){ alert('Sila log masuk dahulu.'); location.href='/login.html'; }
document.getElementById('f').addEventListener('submit', async(e)=>{
  e.preventDefault(); const p=Object.fromEntries(new FormData(e.target).entries()); 
  const r=await ap('/.netlify/functions/submit-minit',{method:'POST',body:JSON.stringify(p)});
  if(r.ok){ document.getElementById('ok').classList.remove('hide'); const a=document.getElementById('wa'); if(r.wa){ a.href=r.wa; a.classList.remove('hide'); } e.target.reset(); } else alert(r.error||'Gagal');
});
</script>

  </main>
</div>
<script>
function token(){return localStorage.getItem('mcToken')||null}
function setToken(t){ if(t) localStorage.setItem('mcToken',t); else localStorage.removeItem('mcToken');}
function parseJwt(t){try{const p=JSON.parse(atob(t.split('.')[1])); return p;}catch{return null}}
function user(){const t=token();return t?parseJwt(t):null}
async function ap(path, opts={}){
  opts.headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
  const t=token(); if(t) opts.headers.Authorization='Bearer '+t;
  const r = await fetch(path, opts); return r.json();
}
const who=document.getElementById('whoami'), bIn=document.getElementById('btnLogin'), bOut=document.getElementById('btnLogout');
function updHeader(){const u=user(); if(u){who.classList.remove('hide'); who.textContent=u.email+' • '+u.role.toUpperCase(); bIn.classList.add('hide'); bOut.classList.remove('hide'); showQuickNav();} else {who.classList.add('hide'); bIn.classList.remove('hide'); bOut.classList.add('hide'); hideQuickNav();}}
function showQuickNav(){ if(document.getElementById('quicknav')) return; const q=document.createElement('div'); q.id='quicknav'; q.style.marginRight='8px'; q.innerHTML=`<a href="/admin.html" class="btn btn-outline" style="margin-right:6px">Admin</a><a href="/pegawai.html" class="btn btn-outline" style="margin-right:6px">Pegawai</a><a href="/pengesah.html" class="btn btn-outline">Pengesah</a>`; bIn.parentNode.insertBefore(q, bIn);}
function hideQuickNav(){ const q=document.getElementById('quicknav'); if(q) q.remove();}
bIn.addEventListener('click',()=>location.href='/login.html'); 
bOut.addEventListener('click',()=>{ setToken(null); updHeader(); location.href='/'; });
updHeader();
</script>
</body></html>
<script>
(function(){ const t=document.getElementById('masa'); if(t && !t.value){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); t.value=z(d.getHours())+':'+z(d.getMinutes()); } })();
async function draftPdf(){ const token=localStorage.getItem('token')||''; const p={tarikh:tarikh.value,masa:masa.value,tempat:tempat.value,tajuk:tajuk.value,catatan:catatan.value,tindakan_ppd:tindakan_ppd.value,rumusan:rumusan.value}; if(!p.tarikh||!p.masa||!p.tajuk){alert('Lengkapkan Tarikh, Masa & Tajuk.');return;} const r=await fetch('/.netlify/functions/save-draft',{method:'POST',headers:{'content-type':'application/json','Authorization':token},body:JSON.stringify(p)}).then(r=>r.json()); if(r.ok&&r.pdfDataUrl){ window.open(r.pdfDataUrl,'_blank'); alert('Draf disimpan & PDF dijana.'); } else alert(r.error||'Gagal jana draf.'); }
async function hantarTimbalan(){ const f=document.getElementById('minitForm'); if(!f.reportValidity()) return; const token=localStorage.getItem('token')||''; const p={tarikh:tarikh.value,masa:masa.value,tempat:tempat.value,tajuk:tajuk.value,catatan:catatan.value,tindakan_ppd:tindakan_ppd.value,rumusan:rumusan.value}; const r=await fetch('/.netlify/functions/submit-minit',{method:'POST',headers:{'content-type':'application/json','Authorization':token},body:JSON.stringify(p)}).then(r=>r.json()); if(r.ok){ if(confirm('Berjaya dihantar. Nak lihat status penghantaran sekarang?')){ toggleStatus(true); } else { location.reload(); } } else alert(r.error||'Gagal hantar.'); }
</script>

<section id="statusSaya" class="card" style="margin:16px 0; padding:16px; border-radius:16px; display:none">
  <h3 style="margin-top:0">Status Penghantaran Saya</h3>
  <div id="statusList" style="font-size:14px;color:#334155">Memuat...</div>
</section>
<script>
async function toggleStatus(show){
  const sec=document.getElementById('statusSaya');
  sec.style.display = show ? 'block' : 'none';
  if(show){ await loadStatusSaya(); }
}
async function loadStatusSaya(){
  const token=localStorage.getItem('token')||'';
  const res = await fetch('/.netlify/functions/pegawai-list-self', { headers:{'Authorization':token} }).then(r=>r.json());
  const el=document.getElementById('statusList');
  if(!res.ok){ el.textContent = res.error||'Gagal'; return; }
  if(!res.items.length){ el.textContent = 'Tiada rekod.'; return;}
  const rows = res.items.sort((a,b)=> (b.tarikh||'').localeCompare(a.tarikh||''));
  const html = rows.map(r=>{
    return `<div style="padding:8px 0;border-bottom:1px solid #e5e7eb">
      <div><b>${r.tajuk||'-'}</b> — <span style="font-size:12px;color:#64748b">${r.tarikh||''} ${r.masa||''}</span></div>
      <div>Status: <span style="font-weight:700">${r.status||'-'}</span></div>
    </div>`;
  }).join('');
  el.innerHTML = html;
}
</script>
