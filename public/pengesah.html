<!doctype html><html lang="ms"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pengesah • Sahkan & E‑mel PDF</title>
<link rel="stylesheet" href="./theme.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script></head><body>
<div class="banner"></div>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <img src="/logo.png" onerror="this.src='/.netlify/functions/assets/logo.png'">
      <div>
        <h1>PEJABAT PENDIDIKAN DAERAH MERSING</h1>
        <small>APLIKASI PEREKODAN MINIT CURAI • SEKTOR PEMBELAJARAN</small>
      </div>
    </div>
    <div class="spacer"></div>
    <span id="whoami" class="badge hide"></span>
    <a id="btnLogin" class="btn btn-outline">Log Masuk</a>
    <a id="btnLogout" class="btn btn-outline hide">Log Keluar</a>
  </header>
  <main class="kid">

<section class="card card-pad">
  <div class="grid" style="grid-template-columns:repeat(2, minmax(140px, 1fr));gap:10px">
    <input id="qFrom" class="input" type="date" placeholder="Dari">
    <input id="qTo" class="input" type="date" placeholder="Hingga">
    <input id="qEmail" class="input" placeholder="Emel Pegawai">
    <select id="qStatus" class="select">
      <option value="">Status: Semua</option>
      <option value="PENDING">PENDING</option>
      <option value="APPROVED">APPROVED</option>
    </select>
    <a id="btnFilter" class="btn btn-outline">Tapis</a>
    <a id="btnReset" class="btn btn-outline">Reset</a>
  </div>
</section>

<section id="list" class="kid"></section>

<div id="pvMask" class="modal-mask">
  <div class="modal">
    <header>
      <strong>Preview Minit Curai</strong>
      <button class="close" onclick="pvClose()">Tutup</button>
    </header>
    <div id="pvBody" class="body"></div>
  </div>
</div>

<script>
const me=user(); if(!me || me.role!=='pengesah'){ alert('Untuk Timbalan/Pengesah'); location.href='/'; }
function pvOpen(html){ pvBody.innerHTML = html; pvMask.style.display='flex'; }
function pvClose(){ pvMask.style.display='none'; }
function renderPreview(it){
  return `
    <div class="printish">
      <div style="text-align:center;margin-bottom:8px">
        <img src="/logo.png" onerror="this.src='/.netlify/functions/assets/logo.png'" style="height:70px"><br/>
        <div style="font-weight:800">PEJABAT PENDIDIKAN DAERAH MERSING</div>
        <div>APLIKASI PEREKODAN MINIT CURAI • SEKTOR PEMBELAJARAN</div>
      </div>
      <div class="row"><div><b>Tarikh</b></div><div>${it.tarikh||'-'}</div></div>
      <div class="row"><div><b>Masa</b></div><div>${it.masa||'-'}</div></div>
      <div class="row"><div><b>Tempat</b></div><div>${it.tempat||'-'}</div></div>
      <div class="row"><div><b>Tajuk</b></div><div>${it.tajuk||'-'}</div></div>
      <div class="row"><div><b>Pegawai</b></div><div>${it.pegawai_nama||''} &lt;${it.pegawai_email||''}&gt;</div></div>
      <div style="height:6px"></div>
      <div><b>Catatan</b><div>${(it.catatan||'').replaceAll('\n','<br/>')}</div></div>
      <div style="height:6px"></div>
      <div><b>Tindakan PPD</b><div>${(it.tindakan_ppd||'').replaceAll('\n','<br/>')}</div></div>
      <div style="height:6px"></div>
      <div><b>Rumusan</b><div>${(it.rumusan||'').replaceAll('\n','<br/>')}</div></div>
    </div>`;
}
async function loadList(){
  const r=await ap('/.netlify/functions/list-minit',{method:'POST',body:JSON.stringify({})});
  const box=document.getElementById('list'); box.innerHTML='';
  if(r.ok){
    (r.items||[]).forEach(it=>{
      const div=document.createElement('div'); div.className='card card-pad'; div.style.margin='10px 0';
      div.innerHTML=`
        <div class="grid" style="grid-template-columns:2fr 3fr 1fr; gap:12px">
          <div>
            <div class="title">${it.tajuk}</div>
            <div class="note">${it.tarikh} • ${it.masa} • ${it.tempat}</div>
            <div class="note">Pegawai: ${it.pegawai_nama} (${it.pegawai_email})</div>
            <div class="badge">${it.status}</div>
          </div>
          <div>
            <div><b>Catatan:</b> ${it.catatan}</div>
            <div><b>Tindakan PPD:</b> ${it.tindakan_ppd}</div>
            <div><b>Rumusan:</b> ${it.rumusan}</div>
          </div>
          <div class="grid">
            ${it.status!=='APPROVED' ? `<a data-id="${'${it.id}'}" class="btn btn-primary">Sahkan & E‑mel PDF</a>` : ''}
            <a class="btn btn-gold" onclick='pvOpen(renderPreview(${ 'it' }))'>Preview</a>
          </div>
        </div>`;
      box.appendChild(div);
    });
    box.querySelectorAll('a[data-id]').forEach(b=>b.addEventListener('click', async()=>{
      const id=b.getAttribute('data-id'); const res=await ap('/.netlify/functions/approve-minit',{method:'POST',body:JSON.stringify({id})});
      if(res.ok){ alert('Disahkan.'); loadList(); } else alert(res.error||'Gagal.');
    }));
  } else { box.textContent=r.error||'Ralat.'; }
}
document.getElementById('btnFilter').addEventListener('click', loadList);
document.getElementById('btnReset').addEventListener('click', ()=>{ loadList(); });
loadList();
</script>

  </main>
</div>
<script>
function token(){return localStorage.getItem('mcToken')||null}
function setToken(t){ if(t) localStorage.setItem('mcToken',t); else localStorage.removeItem('mcToken');}
function parseJwt(t){try{const p=JSON.parse(atob(t.split('.')[1])); return p;}catch{return null}}
function user(){const t=token();return t?parseJwt(t):null}
async function ap(path, opts={}){
  opts.headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
  const t=token(); if(t) opts.headers.Authorization='Bearer '+t;
  const r = await fetch(path, opts); return r.json();
}
const who=document.getElementById('whoami'), bIn=document.getElementById('btnLogin'), bOut=document.getElementById('btnLogout');
function updHeader(){const u=user(); if(u){who.classList.remove('hide'); who.textContent=u.email+' • '+u.role.toUpperCase(); bIn.classList.add('hide'); bOut.classList.remove('hide'); showQuickNav();} else {who.classList.add('hide'); bIn.classList.remove('hide'); bOut.classList.add('hide'); hideQuickNav();}}
function showQuickNav(){ if(document.getElementById('quicknav')) return; const q=document.createElement('div'); q.id='quicknav'; q.style.marginRight='8px'; q.innerHTML=`<a href="/admin.html" class="btn btn-outline" style="margin-right:6px">Admin</a><a href="/pegawai.html" class="btn btn-outline" style="margin-right:6px">Pegawai</a><a href="/pengesah.html" class="btn btn-outline">Pengesah</a>`; bIn.parentNode.insertBefore(q, bIn);}
function hideQuickNav(){ const q=document.getElementById('quicknav'); if(q) q.remove();}
bIn.addEventListener('click',()=>location.href='/login.html'); 
bOut.addEventListener('click',()=>{ setToken(null); updHeader(); location.href='/'; });
updHeader();
</script>
</body></html>
<script>
(function(){
  const form=document.querySelector('form');
  if(form){
    const btn=document.createElement('button'); btn.className='btn'; btn.id='resetFilterPengesah'; btn.textContent='Reset';
    form.appendChild(btn);
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      ['fromDate','toDate','filterEmail','filterStatus'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      if(window.__lastList){ renderList(window.__lastList); }
    });
  }
})();
</script>
