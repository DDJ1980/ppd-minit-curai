<!doctype html><html lang="ms"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pengesah • Sahkan & E‑mel PDF</title>
<link rel="stylesheet" href="./theme.css">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head><body>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <img src="/.netlify/functions/assets/logo.png" onerror="this.src='netlify/functions/assets/logo.png'">
      <div>
        <h1>PPD Mersing <small>Platform Minit Curai • Sektor Pembelajaran</small></h1>
      </div>
    </div>
    <div class="spacer"></div>
    <span id="whoami" class="badge hide"></span>
    <a id="btnLogin" class="btn btn-outline">Log Masuk</a>
    <a id="btnLogout" class="btn btn-outline hide">Log Keluar</a>
  </header>
  <main class="kid">

<section class="card card-pad">
  <div class="grid" style="grid-template-columns:repeat(2, minmax(140px, 1fr));gap:10px">
    <input id="qFrom" class="input" type="date" placeholder="Dari">
    <input id="qTo" class="input" type="date" placeholder="Hingga">
    <input id="qEmail" class="input" placeholder="Emel Pegawai">
    <select id="qStatus" class="select">
      <option value="">Status: Semua</option>
      <option value="PENDING">PENDING</option>
      <option value="APPROVED">APPROVED</option>
    </select>
    <a id="btnFilter" class="btn btn-outline">Tapis</a>
    <a id="btnReset" class="btn btn-outline">Reset</a>
  </div>
</section>

<section id="list" class="kid"></section>

<script>
if(!cu()){ alert('Sila log masuk dahulu.'); location.href='/' }
async function loadList(){
  const r=await ap('/.netlify/functions/list-minit',{method:'POST',body:JSON.stringify({})});
  const box=document.getElementById('list'); box.innerHTML='';
  if(r.ok){
    (r.items||[]).forEach(it=>{
      const div=document.createElement('div'); div.className='card card-pad'; div.style.margin='10px 0';
      div.innerHTML=`
        <div class="grid" style="grid-template-columns:2fr 3fr 1fr; gap:12px">
          <div>
            <div class="title">${it.tajuk}</div>
            <div class="note">${it.tarikh} • ${it.masa} • ${it.tempat}</div>
            <div class="note">Pegawai: ${it.pegawai_nama} (${it.pegawai_email})</div>
            <div class="badge">${it.status}</div>
          </div>
          <div>
            <div><b>Catatan:</b> ${it.catatan}</div>
            <div><b>Tindakan PPD:</b> ${it.tindakan_ppd}</div>
            <div><b>Rumusan:</b> ${it.rumusan}</div>
          </div>
          <div class="grid">
            ${it.status!=='APPROVED' ? `<a data-id="${it.id}" class="btn btn-primary">Sahkan & E‑mel PDF</a>` : ''}
            ${it.pdfUrl? `<a class="btn btn-outline" target="_blank" href="${it.pdfUrl}">Lihat PDF</a>`: ''}
          </div>
        </div>`;
      box.appendChild(div);
    });
    box.querySelectorAll('a[data-id]').forEach(b=>b.addEventListener('click', async()=>{
      const id=b.getAttribute('data-id'); const res=await ap('/.netlify/functions/approve-minit',{method:'POST',body:JSON.stringify({id})});
      if(res.ok){ alert('Disahkan. E‑mel dihantar (jika SMTP betul).'); loadList(); if(res.pdfUrl) window.open(res.pdfUrl,'_blank'); } else alert(res.error||'Gagal.');
    }));
  } else { box.textContent=r.error||'Ralat.'; }
}
document.getElementById('btnFilter').addEventListener('click', loadList);
document.getElementById('btnReset').addEventListener('click', ()=>{ loadList(); });
loadList();
</script>

  </main>
  <p class="footer">© PPD Mersing • Tema rasmi biru–kuning</p>
</div>
<script>
function cu(){return netlifyIdentity&&netlifyIdentity.currentUser()}
async function tok(){const u=cu();return u?await u.token():null}
async function ap(path,opts={}){const t=await tok();opts.headers=Object.assign({'Content-Type':'application/json'},opts.headers||{});if(t)opts.headers.Authorization='Bearer '+t;const r=await fetch(path,opts);return r.json()}
const who=document.getElementById('whoami');const bIn=document.getElementById('btnLogin');const bOut=document.getElementById('btnLogout');
function upd(){const u=cu(); if(u){who.classList.remove('hide'); who.textContent=u.email; bIn.classList.add('hide'); bOut.classList.remove('hide');} else {who.classList.add('hide'); bIn.classList.remove('hide'); bOut.classList.add('hide');}}
bIn.addEventListener('click',()=>netlifyIdentity.open('login')); bOut.addEventListener('click',()=>netlifyIdentity.logout());
netlifyIdentity.on('init',upd); netlifyIdentity.on('login',()=>{upd(); location.reload()}); netlifyIdentity.on('logout',()=>{upd(); location.reload()}); netlifyIdentity.init();
</script>
</body></html>