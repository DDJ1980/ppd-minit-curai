<!doctype html><html lang="ms"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin • Pengguna</title>
<link rel="stylesheet" href="./theme.css">
</head><body>
<div class="banner"></div>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <img src="/logo.png" onerror="this.src='/.netlify/functions/assets/logo.png'">
      <div>
        <h1>PEJABAT PENDIDIKAN DAERAH MERSING</h1>
        <small>APLIKASI PEREKODAN MINIT CURAI • SEKTOR PEMBELAJARAN</small>
      </div>
    </div>
    <div class="spacer"></div>
    <span id="whoami" class="badge hide"></span>
    <a id="btnLogin" class="btn btn-outline">Log Masuk</a>
    <a id="btnLogout" class="btn btn-outline hide">Log Keluar</a>
  </header>
  <main class="kid">

<section class="card card-pad">
  <h3>Pengurusan Pengguna</h3>
  <div class="grid" style="grid-template-columns:repeat(2,auto);gap:10px;margin-bottom:8px">
    <a id="btnList" class="btn btn-outline">Senarai</a>
    <a id="btnSeed" class="btn btn-gold">Seed 17 Pegawai + Timbalan</a>
  </div>
  <form id="uf" class="form">
    <div class="row-2">
      <input class="input" name="name" placeholder="Nama" required>
      <input class="input" name="email" type="email" placeholder="Emel" required>
    </div>
    <div class="row-2">
      <select class="select" name="role">
        <option value="pegawai">Pegawai</option>
        <option value="pengesah">Pengesah (Timbalan)</option>
        <option value="admin">Admin</option>
      </select>
      <input class="input" name="whatsapp" placeholder="WhatsApp (cth 6019xxxxxxx)">
    </div>
    <input class="input" name="password" type="password" placeholder="Set / Tukar kata laluan (opsyenal)">
    <div class="grid" style="grid-template-columns:repeat(2,auto);gap:10px">
      <button class="btn btn-primary" type="submit">Simpan / Kemas Kini</button>
      <button id="btnDelete" class="btn btn-outline" type="button">Padam (ikut emel)</button>
    </div>
  </form>
  <div id="list" class="kid"></div>
</section>
<script>
const me = user(); if(!me || me.role!=='admin'){ alert('Akses admin sahaja'); location.href='/'; }
async function listU(){ const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'list'})}); 
  if(r.ok){ const rows=(r.users||[]).map(u=>`<tr><td>${u.role.toUpperCase()}</td><td>${u.name}</td><td>${u.email}</td><td>${u.whatsapp||''}</td></tr>`).join(''); 
  document.getElementById('list').innerHTML=`<table class='table'><thead><tr><th>Peranan</th><th>Nama</th><th>Emel</th><th>WhatsApp</th></tr></thead><tbody>${rows}</tbody></table>`;}}
document.getElementById('btnList').onclick=listU;
document.getElementById('uf').addEventListener('submit', async(e)=>{ e.preventDefault(); const p=Object.fromEntries(new FormData(e.target).entries()); const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'upsert',user:p})}); alert(r.ok?'Disimpan':'Gagal'); listU(); e.target.reset();});
document.getElementById('btnDelete').onclick = async()=>{ const email=document.querySelector('[name=email]').value; if(!email) return alert('Isi emel'); const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'delete',email})}); alert(r.ok?'Dipadam':'Gagal'); listU(); };
document.getElementById('btnSeed').onclick = async()=>{ if(!confirm('Seed pengguna rasmi?')) return; const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'seed'})}); alert(r.ok?'Done':'Gagal'); listU(); };
listU();
</script>

  </main>
</div>
<script>
function token(){return localStorage.getItem('mcToken')||null}
function setToken(t){ if(t) localStorage.setItem('mcToken',t); else localStorage.removeItem('mcToken');}
function parseJwt(t){try{const p=JSON.parse(atob(t.split('.')[1])); return p;}catch{return null}}
function user(){const t=token();return t?parseJwt(t):null}
async function ap(path, opts={}){
  opts.headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
  const t=token(); if(t) opts.headers.Authorization='Bearer '+t;
  const r = await fetch(path, opts); return r.json();
}
const who=document.getElementById('whoami'), bIn=document.getElementById('btnLogin'), bOut=document.getElementById('btnLogout');
function updHeader(){const u=user(); if(u){who.classList.remove('hide'); who.textContent=u.email+' • '+u.role.toUpperCase(); bIn.classList.add('hide'); bOut.classList.remove('hide'); showQuickNav();} else {who.classList.add('hide'); bIn.classList.remove('hide'); bOut.classList.add('hide'); hideQuickNav();}}
function showQuickNav(){ if(document.getElementById('quicknav')) return; const q=document.createElement('div'); q.id='quicknav'; q.style.marginRight='8px'; q.innerHTML=`<a href="/admin.html" class="btn btn-outline" style="margin-right:6px">Admin</a><a href="/pegawai.html" class="btn btn-outline" style="margin-right:6px">Pegawai</a><a href="/pengesah.html" class="btn btn-outline">Pengesah</a>`; bIn.parentNode.insertBefore(q, bIn);}
function hideQuickNav(){ const q=document.getElementById('quicknav'); if(q) q.remove();}
bIn.addEventListener('click',()=>location.href='/login.html'); 
bOut.addEventListener('click',()=>{ setToken(null); updHeader(); location.href='/'; });
updHeader();
</script>
</body></html>