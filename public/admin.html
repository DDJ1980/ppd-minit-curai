<!doctype html><html lang="ms"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin • Urus Pengguna</title>
<link rel="stylesheet" href="./theme.css">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head><body>
<div class="banner"></div>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <img src="/logo.png" onerror="this.src='/.netlify/functions/assets/logo.png'">
      <div>
        <h1>PEJABAT PENDIDIKAN DAERAH MERSING</h1>
        <small>APLIKASI PEREKODAN MINIT CURAI • SEKTOR PEMBELAJARAN</small>
      </div>
    </div>
    <div class="spacer"></div>
    <span id="whoami" class="badge hide"></span>
    <a id="btnLogin" class="btn btn-outline">Log Masuk</a>
    <a id="btnLogout" class="btn btn-outline hide">Log Keluar</a>
  </header>
  <main class="kid">

<section class="card card-pad fade-in">
  <div class="grid" style="grid-template-columns:repeat(2,auto);gap:10px">
    <a id="btnSeed" class="btn btn-gold">Seed Pengguna</a>
    <a id="btnList" class="btn btn-outline">Senarai</a>
    <a id="btnExport" class="btn btn-outline">Export CSV</a>
    <a id="btnAudit" class="btn btn-outline">Audit CSV</a>
  </div>
  <p class="note" style="margin-top:10px">Hanya admin boleh akses. Admin ditentukan oleh <code>ADMIN_EMAIL</code>.</p>

  <form id="userForm" class="form kid">
    <div class="row-2">
      <input class="input" name="name" placeholder="Nama" required>
      <input class="input" name="email" type="email" placeholder="Emel" required>
    </div>
    <div class="row-2">
      <select class="select" name="role">
        <option value="pegawai">Pegawai</option>
        <option value="pengesah">Pengesah (Timbalan)</option>
      </select>
      <input class="input" name="whatsapp" placeholder="WhatsApp (cth 6019xxxxxxx)">
    </div>
    <div class="grid" style="grid-template-columns:repeat(2,auto);gap:10px">
      <button class="btn btn-primary" type="submit">Simpan / Kemas Kini</button>
      <button id="btnDelete" type="button" class="btn btn-outline">Padam (ikut emel)</button>
    </div>
  </form>

  <div id="usersBox" class="kid"></div>
</section>

<script>
if(!cu()){ alert('Sila log masuk dahulu.'); location.href='/'; }
async function must(){const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'whoami'})}); if(!r.ok||!r.isAdmin){alert('Akses admin sahaja'); location.href='/';}}
async function listUsers(){
  const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'list'})});
  const box=document.getElementById('usersBox');
  if(r.ok){
    const rows=(r.users||[]).map(u=>`<tr><td>${(u.role||'').toUpperCase()}</td><td>${u.name||''}</td><td>${u.email||''}</td><td>${u.whatsapp? '+'+u.whatsapp:''}</td></tr>`).join('');
    box.innerHTML = `<div class='card card-pad'><table style="width:100%;border-collapse:collapse"><thead><tr><th align="left">Peranan</th><th align="left">Nama</th><th align="left">Emel</th><th align="left">WhatsApp</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  } else { box.textContent='Gagal memuat.'; }
}
document.getElementById('btnSeed').addEventListener('click', async()=>{const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'seed'})}); alert(r.ok?'Seed OK':'Gagal'); listUsers(); });
document.getElementById('btnList').addEventListener('click', listUsers);
document.getElementById('userForm').addEventListener('submit', async(e)=>{e.preventDefault(); const fd=new FormData(e.target); const p=Object.fromEntries(fd.entries()); const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'upsert',user:p})}); alert(r.ok?'Disimpan':'Gagal'); if(r.ok) e.target.reset(); listUsers(); });
document.getElementById('btnDelete').addEventListener('click', async()=>{ const email=document.querySelector('[name=email]').value; if(!email) return alert('Isi emel dulu'); const r=await ap('/.netlify/functions/admin-users',{method:'POST',body:JSON.stringify({action:'delete',email})}); alert(r.ok?'Dipadam':'Gagal'); listUsers(); });
document.getElementById('btnExport').addEventListener('click', async()=>{ const t=await tok(); const res=await fetch('/.netlify/functions/export-csv', {headers: t? {Authorization:'Bearer '+t}:{}}); const b=await res.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='laporan-minit.csv'; a.click(); });
document.getElementById('btnAudit').addEventListener('click', async()=>{ const t=await tok(); const res=await fetch('/.netlify/functions/audit-export', {headers: t? {Authorization:'Bearer '+t}:{}}); const b=await res.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='audit-log.csv'; a.click(); });
must(); listUsers();
</script>

  </main>
</div>
<script>
function cu(){return netlifyIdentity&&netlifyIdentity.currentUser()}
async function tok(){const u=cu();return u?await u.token():null}
async function ap(path,opts={}){const t=await tok();opts.headers=Object.assign({'Content-Type':'application/json'},opts.headers||{});if(t)opts.headers.Authorization='Bearer '+t;const r=await fetch(path,opts);return r.json()}
const who=document.getElementById('whoami');const bIn=document.getElementById('btnLogin');const bOut=document.getElementById('btnLogout');
function upd(){
  const u=cu();
  if(u){
    who.classList.remove('hide'); who.textContent=u.email; bIn.classList.add('hide'); bOut.classList.remove('hide');
    if(!document.getElementById('quicknav')){
      const q=document.createElement('div'); q.id='quicknav'; q.style.marginRight='8px';
      q.innerHTML=`<a href="/admin.html" class="btn btn-outline" style="margin-right:6px">Admin</a>
                   <a href="/pegawai.html" class="btn btn-outline" style="margin-right:6px">Pegawai</a>
                   <a href="/pengesah.html" class="btn btn-outline">Pengesah</a>`;
      bIn.parentNode.insertBefore(q, bIn);
    }
  } else {
    who.classList.add('hide'); bIn.classList.remove('hide'); bOut.classList.add('hide');
    const q=document.getElementById('quicknav'); if(q) q.remove();
  }
}
bIn.addEventListener('click',()=>netlifyIdentity.open('login')); bOut.addEventListener('click',()=>netlifyIdentity.logout());
netlifyIdentity.on('init',upd); netlifyIdentity.on('login',()=>{upd();}); netlifyIdentity.on('logout',()=>{upd();}); netlifyIdentity.init();
</script>
</body></html>